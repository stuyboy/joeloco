function proximityListener(){var e=geoFire.query({center:[defaultCenter.lat,defaultCenter.lng],radius:radiusInKm});e.on("key_entered",function(e,t){markers[e]=createMarker(t),initFinished&&zoomMoveMapToMarkers()}),e.on("key_exited",function(e,t){map.removeLayer(markers[e]),removeMarker(e)}),e.on("key_moved",function(e,t){var n=markers[e];"undefined"!=typeof n&&"undefined"!=typeof n&&n.animatedMoveTo(t)}),e.on("ready",function(){zoomMoveMapToMarkers(),initFinished=!0})}function createMarker(e){var t=L.marker(e).addTo(map);return t}function removeMarker(e){if("undefined"!=typeof markers){var t=markers[e];"undefined"!=typeof t&&(map.removeLayer(markers[e]),delete markers[e])}}function checkEventValidity(){if("undefined"!=typeof mainEvent){if(Date.now()>mainEvent.dateEnd)return"EXPIRED";if(Date.now()<mainEvent.dateStart)return"PENDING";if(Date.now()<=mainEvent.dateEnd&&Date.now()>=mainEvent.dateStart)return"ON"}return"EXPIRED"}function registerUserListener(e){var t=getGeoFirebase().child(e);t.on("value",function(t){if(t.exists())if(checkEventValidity()){var n=t.val(),r=markers[e];"undefined"==typeof r?(r=createMarker(n.l),markers[e]=r,popup=r.bindPopup("Lat: "+n.l[0]+" Long: "+n.l[1]).openPopup()):r.animatedMoveTo(n.l),map.setView(new L.latLng(n.l[0],n.l[1])),popup.update()}else shutdownMapTracking()})}function registerGroupUserListeners(e){var t=getGroupMembersFirebase(e);t.once("value",function(e){if(e.exists()){var t=e.val();for(var n in t)t.hasOwnProperty(n)&&registerUserListener(n)}})}function queryEventDetails(e){var t=getEventFirebase(e);t.on("value",function(e){if(e.exists()){var t=e.val();mainEvent=t;var n=checkEventValidity();"ON"==n?(showOverlay(!1),registerGroupUserListeners(t.groupId)):"EXPIRED"==n?shutdownMapTracking("Event has Expired. Realtime Tracking Disabled."):"PENDING"==n&&shutdownMapTracking("Realtime Tracking disabled until event start.")}})}function shutdownMapTracking(e){for(var t in markers)removeMarker(t);showOverlay(!0);var n=document.getElementById("overlayText");"undefined"!=typeof n&&(n.innerText=e)}function showOverlay(e){var t=document.getElementById("overlay");"undefined"!=typeof t&&(e?t.style.display="block":t.style.display="none")}function coordinatesAreEquivalent(e,t){return Math.abs(e-t)<1e-6}function panMapToInclude(e){map.getBounds().contains(e)||map.panTo(e)}function zoomMoveMapToMarkers(){var e=[];for(var t in markers){var n=markers[t].getLatLng();e.push(n)}var r=L.latLngBounds(e);map.fitBounds(r)}function initGroupsNearby(){var e=qs.groupId,t=qs.eventId;"undefined"!=typeof t?queryEventDetails(t):"undefined"!=typeof e?registerGroupUserListeners(e):proximityListener()}var loco=angular.module("loco",["templates","firebase","loco.homeModule","loco.mapModule"]);loco.config([function(){}]),loco.run(["$rootScope",function(e){}]);var locoFilters=angular.module("loco.filters",[]);locoFilters.filter("startFrom",function(){return function(e,t){return t=+t,e.slice(t)}});var homeModule=angular.module("loco.homeModule",["ui.router"]);homeModule.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/home",templateUrl:"home.html",controller:"HomeController"}),t.otherwise("/home")}]),homeModule.controller("HomeController",["$scope","$log",function(e,t){t.log("home")}]);var mapModule=angular.module("loco.mapModule",["ui.router","ngResource","ngCookies","geolocation","leaflet-directive","angularMoment","loco.firebase","loco.timeout","uuid4"]);mapModule.config(["$stateProvider",function(e){e.state("map",{url:"/map/:eventId",templateUrl:"map/map.html",controller:"MapController"})}]),mapModule.run(["$rootScope",function(e){}]),mapModule.controller("MapController",["$scope","$document","$stateParams","$cookies","firebaseService","geolocation","timeoutService","uuid4",function(e,t,n,r,o,a,i,c){var l=r.get("WEB_USER_ID");l||(l=c.generate(),r.put("WEB_USER_ID",l));var s="pk.eyJ1Ijoiam9lY2hhbmciLCJhIjoicEp0Q3NSQSJ9.ws11nLqGvsMzLTJ0U-I_5Q";angular.extend(e,{center:{lat:37.7833,lng:-122.4167,zoom:13},markers:{},defaults:{tileLayer:"http://{s}.tiles.mapbox.com/v4/joechang.f7451cba/{z}/{x}/{y}.png?access_token="+s,tileLayerOptions:{opacity:.9,detectRetina:!0,reuseTiles:!0,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>'},maxZoom:18}});var u={iconUrl:"img/marker-icon-red.png",iconSize:[25,41],iconAnchor:[13,41],popupAnchor:[0,-35]},d=function(){a.getLocation().then(function(t){e.markers.web?(e.markers.web.lat=t.coords.latitude,e.markers.web.lng=t.coords.longitude):e.markers.web={lat:t.coords.latitude,lng:t.coords.longitude,message:"me",focus:!0,draggable:!1,icon:u},o.addLocation(l,e.markers.web)})},m=function(t){o.getUser(t).$loaded().then(function(n){e.markers[t].message=n.fullname,confirm("Share your location with "+n.fullname+"?")&&(d(),i.interval(d,1e3,e))})},f=function(t){o.getGeo(t).$loaded().then(function(n){e.markers[t]?(e.markers[t].lat=n.l[0],e.markers[t].lng=n.l[1]):(e.markers[t]={lat:n.l[0],lng:n.l[1],focus:!0,draggable:!1},m(t)),e.center.lat=n.l[0],e.center.lng=n.l[1]})},v=o.getEventMemberLocations(n.eventId);v.then(function(e){e.map(function(e){e.$watch(function(){f(e.$ref().key())})})})["catch"](function(e){}),e.me=function(e){return e.userid===l},e.chat={text:"",messages:o.getChat(n.eventId)},e.sendMessage=function(){if(e.chat.text){var t={message:e.chat.text,name:"Web User",userid:l,time:Date.now()};e.chat.messages.$add(t),e.chat.text=""}}}]),mapModule.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),mapModule.directive("chatScroll",function(){return{scope:{chatScroll:"="},link:function(e,t){e.$watchCollection("chatScroll",function(e){e&&$(t).scrollTop($(t)[0].scrollHeight)})}}});var envService=angular.module("loco.env",[]);envService.config(["$sceDelegateProvider","locoServiceHost",function(e,t){e.resourceUrlWhitelist(["self",t])}]),envService.constant("locoServiceHost","REPLACE_LOCO_SERVICE_HOST"),envService.constant("locoJsHost","REPLACE_JS_HOST"),envService.constant("locoResourceHost","REPLACE_RESOURCE_HOST");var firebaseService=angular.module("loco.firebase",["firebase"]);firebaseService.service("firebaseService",["$log","$q","$firebaseObject","$firebaseArray",function(e,t,n,r){var o=new Firebase("https://joeloco.firebaseio.com/"),a=new GeoFire(o.child("rtLocations")),i=function(e){return n(o.child("groups").child(e))};this.getGroup=i;var c=function(e){return n(o.child("users").child(e))};this.getUser=c;var l=function(e){return n(o.child("events").child(e))};this.getEvent=l;var s=function(e){return r(o.child("chats").child(e).child("messages"))};this.getChat=s;var u=function(e){return n(a.ref().child(e))};this.getGeo=u;var d=function(e,t){o.child("rtLocations").child(e).set({g:1,l:[t.lat,t.lng]})};this.addLocation=d,this.getEventMemberLocations=function(e){var n=t.defer(),r=l(e);return r.$loaded().then(function(e){var t=i(e.groupId);t.$loaded().then(function(e){n.resolve(Object.keys(e.members).map(function(e){return u(e)}))})["catch"](function(e){})})["catch"](function(e){}),n.promise}}]);var mapService=angular.module("loco.map",["geolocation","loco.firebase","duScroll"]);mapService.service("mapService",["$log","firebaseService",function(e,t){}]);var radiusInKm=20,markers={},initFinished=!1,mainEvent,popup;L.Marker.prototype.animatedMoveTo=function(e){var t=e[0],n=e[1],r=this.getLatLng().lat,o=this.getLatLng().lng;if(!coordinatesAreEquivalent(r,t)||!coordinatesAreEquivalent(o,n))var a=0,i=t-r,c=n-o,l=window.setInterval(function(){a+=.01;var e=r+a*i,t=o+a*c,n=new L.latLng(e,t);this.setLatLng(n),a>=1&&window.clearInterval(l)}.bind(this),10)};var timeoutService=angular.module("loco.timeout",[]);timeoutService.service("timeoutService",["$timeout","$interval",function(e,t){this.timeout=function(t,n,r){var o=e(t,n);return r&&r.$on("$destroy",function(t){e.cancel(o)}),function(){e.cancel(o)}},this.interval=function(e,n,r){var o=t(e,n);return r.$on("$destroy",function(e){t.cancel(o)}),function(){t.cancel(o)}}}]);